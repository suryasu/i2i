YUI.add("privacy-helper",function(e){function t(e){var t,n,r,i,s;return t={isPublic:!1,isVisibleByFriends:!1,isVisibleByFamily:!1},n={isPublic:!0,isVisibleByFriends:!1,isVisibleByFamily:!1},r={isPublic:!1,isVisibleByFriends:!0,isVisibleByFamily:!1},i={isPublic:!1,isVisibleByFriends:!1,isVisibleByFamily:!0},s={isPublic:!1,isVisibleByFriends:!0,isVisibleByFamily:!0},typeof e=="object"?e.isPublic?"public":e.isVisibleByFriends&&e.isVisibleByFamily?"friendsandfamily":e.isVisibleByFamily?"family":e.isVisibleByFriends?"friends":"private":e==="public"?n:e==="friendsandfamily"?s:e==="friends"?r:e==="family"?i:t}e.PrivacyHelper={mapPrivacy:t}},"@VERSION@",{requires:[]});
YUI.add("hermes-template-flag-photo-dialog-content",function(e,t){var n=e.Template.Handlebars.revive({1:function(e,t,n,r,i){var s;return(s=n["if"].call(t!=null?t:{},t!=null?t.fallsWithinSettings:t,{name:"if",hash:{},fn:e.program(2,i,0),inverse:e.program(4,i,0),data:i}))!=null?s:""},2:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_SAFE_WITHIN"},data:i}))+"\n"},4:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_SAFE_OUTSIDE"},data:i}))+"\n"},6:function(e,t,n,r,i){var s;return(s=n["if"].call(t!=null?t:{},t!=null?t.fallsWithinSettings:t,{name:"if",hash:{},fn:e.program(7,i,0),inverse:e.program(9,i,0),data:i}))!=null?s:""},7:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_MODERATE_WITHIN"},data:i}))+"\n"},9:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_MODERATE_OUTSIDE"},data:i}))+"\n"},11:function(e,t,n,r,i){var s;return(s=n["if"].call(t!=null?t:{},t!=null?t.fallsWithinSettings:t,{name:"if",hash:{},fn:e.program(12,i,0),inverse:e.program(14,i,0),data:i}))!=null?s:""},12:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_RESTRICTED_WITHIN"},data:i}))+"\n"},14:function(e,t,n,r,i){return"		"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FLAG_CONFIRMATION_RESTRICTED_OUTSIDE"},data:i}))+"\n"},compiler:[7,">= 4.0.0"],main:function(e,t,n,r,i){var s,o=t!=null?t:{};return((s=n["if"].call(o,t!=null?t.isSafe:t,{name:"if",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i}))!=null?s:"")+"\n"+((s=n["if"].call(o,t!=null?t.isModerate:t,{name:"if",hash:{},fn:e.program(6,i,0),inverse:e.noop,data:i}))!=null?s:"")+"\n"+((s=n["if"].call(o,t!=null?t.isRestricted:t,{name:"if",hash:{},fn:e.program(11,i,0),inverse:e.noop,data:i}))!=null?s:"")+"\n"+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(o,{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.FOR_MORE_INFORMATION_SAFESEARCH"},data:i}))},useData:!0}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/flag-photo-dialog-content",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("sub-photo-additional-info-view",function(e,t){var n=require("lib/flog")(t),r,i;i={debug:!1,css:{safetyLevel:".c-charm-item-safetylevel .ui-dropdown",privacy:".c-charm-item-privacy .ui-dropdown",commentingPermission:".commenting-permission .ui-dropdown",addMetaPermission:".add-meta-permission .ui-dropdown"},stateCSS:{working:"working",apiError:"api-error"}},r={log:function(){if(!i.debug||!console.log.apply)return;var e=new Array(arguments.length);for(var t=0;t<e.length;++t)e[t]=arguments[t];e.unshift("color: #FC0"),e.unshift("%c[CHARM-EXIF]"),console.log.apply(console,e)}},e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.nsid=e.nsid,this.photoId=e.photoId,this.backToURL=e.backToURL,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},buildContainer:function(){var t,n=this.get("photo"),r=n.getValue("owner").getValue("isMe"),i=!1,s=!r&&this.appContext.getViewer().signedIn,o=!0;return t={safetyLevel:n?n.getValue("safetyLevel"):"none",privacy:this.get("privacy")?this.get("privacy").toJSON():{},commentingPermission:this.get("privacy").getValue("permComment"),addMetaPermission:this.get("privacy").getValue("permAddMeta"),privacySelected:this.get("privacy")?e.PrivacyHelper.mapPrivacy(this.get("privacy").toJSON()).toLowerCase():"",isOwner:r,dropUp:i,isVideo:n?n.getValue("isVideo"):!1,showFlagPhoto:s,showFeedback:o},this.setContainerWithTemplate("sub-photo-additional-info",t),this},setSafetyLevel:function(e){var t=this,r=this.get("photo"),s=r.getValue("safetyLevel"),o=this.get("container").one(".c-charm-item-safetylevel"),u=this.get("container").one(".c-charm-item-safetylevel i");r.setValue("safetyLevel",e),u.replaceClass("ui-icon-tiny-safety-"+s,"ui-icon-tiny-safety-"+e),o&&(o.addClass(i.stateCSS.working),o.removeClass(i.stateCSS.apiError)),e==="restricted"?this.fire("subviewViewEvent","disable-sharing"):this.fire("subviewViewEvent","enable-sharing"),r.remoteUpdate().then(function(){o&&o.removeClass(i.stateCSS.working)},function(a){r.setValue("safetyLevel",s),t.safetyLevelDd.select(s),u.replaceClass("ui-icon-tiny-safety-"+e,"ui-icon-tiny-safety-"+s),o&&(o.removeClass(i.stateCSS.working),o.addClass(i.stateCSS.apiError)),t.onError(t.intlMessage({intlName:"photo-page-scrappy.SAFETY_CHANGE_ERROR"})),n.error({err:a})})},changingToStricterPrivacy:function(t){var n=this.get("privacy"),r=e.PrivacyHelper.mapPrivacy(n.toJSON());return t!==r&&(t==="private"||r==="public"||t==="family"&&r==="friends"||t==="friends"&&r==="family"||t==="friendsandfamily"&&r==="friends"||t==="friends"&&r==="friendsandfamily"||t==="family"&&r==="friendsandfamily")},setPrivacy:function(t){var n=this.get("privacy"),r=!1,i=this;!i.stricterPrivacyChangeWarningDialog&&i.changingToStricterPrivacy(t)?(r=!0,i.stricterPrivacyChangeWarningDialog=new e.Views.FluidModal({appContext:i.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,showCancelButton:!0,title:i.intlMessage({intlName:"photo-page-scrappy.STRICTER_PRIVACY_CHANGE_DIALOG_TITLE"}),actionButtonLabel:i.intlMessage({intlName:"common.OK"}),cancelButtonLabel:i.intlMessage({intlName:"common.CANCEL"}),message:i.intlMessage({intlName:"photo-page-scrappy.STRICTER_PRIVACY_CHANGE_DIALOG_MESSAGE"})}),i.stricterPrivacyChangeWarningDialog.on("actionClick",function(e){i.changePrivacy(t,r)}),i.stricterPrivacyChangeWarningDialog.on("cancelClick",function(t){i.stricterPrivacyChangeWarningDialog=undefined,i.privacyDd.select(e.PrivacyHelper.mapPrivacy(n.toJSON()))}),i.stricterPrivacyChangeWarningDialog.show()):i.changePrivacy(t,r)},changePrivacy:function(t,r){var s=this.get("privacy"),o=this.get("container").one(".c-charm-item-privacy"),u=e.PrivacyHelper.mapPrivacy(t),a=e.PrivacyHelper.mapPrivacy(s.toJSON()),f=this.get("container").one(".c-charm-item-privacy i"),l=this;f.replaceClass(f.getDOMNode().className,"ui-icon-tiny-privacy"+t.toLowerCase()),o&&(o.removeClass(i.stateCSS.apiError),o.addClass(i.stateCSS.working)),Object.keys(u).forEach(function(e){s.setValue(e,u[e])}),s.remoteUpdate().then(function(){o&&(o.removeClass(i.stateCSS.working),o.removeClass(i.stateCSS.apiError)),r?e.config.win.location.reload():l.appContext.getModelRegistry("photostream-models").then(function(e){e.removeAll()})},function(t){Object.keys(u).forEach(function(e){s.revertValue(e)}),o&&(o.removeClass(i.stateCSS.working),o.addClass(i.stateCSS.apiError),e.config.win.setTimeout(function(){o&&o.addClass(i.stateCSS.apiError)},100)),a=e.PrivacyHelper.mapPrivacy(s.toJSON()),l.onError(l.intlMessage({intlName:"photo-page-scrappy.PRIVACY_CHANGE_ERROR"})),n.error({err:t})})},setCommentingPermission:function(e){var t=this,r=this.get("privacy"),s=r.getValue("permComment"),o=this.get("container").one(".commenting-permission"),u=this.get("container").one(".ui-icon-tiny-commentPermission"+s);r.setValue("permComment",e),u.replaceClass("ui-icon-tiny-commentPermission"+s,"ui-icon-tiny-commentPermission"+e),o&&(o.addClass(i.stateCSS.working),o.removeClass(i.stateCSS.apiError)),r.remoteUpdate().then(function(){o&&o.removeClass(i.stateCSS.working)},function(a){r.setValue("permComment",s),t.commentingPermissionDd.select(s),u.replaceClass("ui-icon-tiny-commentPermission"+e,"ui-icon-tiny-commentPermission"+s),o&&(o.removeClass(i.stateCSS.working),o.addClass(i.stateCSS.apiError)),t.onError(t.intlMessage({intlName:"photo-page-scrappy.COMMENT_PERMS_UPDATE_ERROR"})),n.error({err:a})})},setAddMetaPermission:function(e){var t=this,r=this.get("privacy"),s=r.getValue("permAddMeta"),o=this.get("container").one(".add-meta-permission"),u=this.get("container").one(".ui-icon-tiny-metaPermission"+s);r.setValue("permAddMeta",e),u.replaceClass("ui-icon-tiny-metaPermission"+s,"ui-icon-tiny-metaPermission"+e),o&&(o.addClass(i.stateCSS.working),o.removeClass(i.stateCSS.apiError)),r.remoteUpdate().then(function(){o&&o.removeClass(i.stateCSS.working)},function(a){r.setValue("permAddMeta",s),t.addMetaPermissionDd.select(s),u.replaceClass("ui-icon-tiny-metaPermission"+
e,"ui-icon-tiny-metaPermission"+s),o&&(o.removeClass(i.stateCSS.working),o.addClass(i.stateCSS.apiError)),t.onError(t.intlMessage({intlName:"photo-page-scrappy.META_PERMS_UPDATE_ERROR"})),n.error({err:a})})},handleFlagPhotoClick:function(t){t.preventDefault();var n=this.get("photo").getValue("safetyLevel"),r=this.get("personPreferences").getValue("safeSearch"),i,s,o,u=this;i=this.templates("flag-photo-dialog-content")({isSafe:n===0,isModerate:n===1,isRestricted:n===2,fallsWithinSettings:n<=r}),s=new e.Views["confirmation-dialog-view"]({photoID:this.photoId,appContext:this.appContext,title:this.intlMessage({intlName:"photo-page-scrappy.FLAG_PHOTO"}),icon:"ui-icon-modal-flag",content:i,confirmButtonLabel:this.intlMessage({intlName:"photo-page-scrappy.MARK_FOR_REVIEW"})}),s.render(),s.activate(),o=s.get("container"),o.all("a").on("click",function(){u.flagDialog.close(),u.flagDialog.destroy()}),s.registerEventHandler(o.one(".ui-dialog-button-confirm").on("click",this.handleFlagPhotoConfirmClick,this)),this.fire("subviewViewEvent","getDialogOffset",function(t){u.flagDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:s.get("container"),appContext:u.appContext,offsetLeft:t,dialogClass:"scrappy-dialog"}),u.flagDialog.show()}),e.rapidTracker.beacon(this.name,"flagPhotoClick")},handleFlagPhotoConfirmClick:function(t){var n=this;e.rapidTracker.beacon(this.name,"flagPhotoConfirmationClick"),n.flagDialog.close(),n.flagDialog.destroy(),this.appContext.callAPI("flickr.moderation.flagPhoto",{photo_id:this.photoId,offensive:1}).then(function(e){n.get("container").one(".flag-photo").replace(n.intlMessage({intlName:"more-menu-view.PHOTO_HAS_BEEN_FLAGGED"}))},function(e){n.onError(n.intlMessage({intlName:"more-menu-view.PROBLEM_FLAGGING"}))})},handleError:function(e){return function(t){r.log(e,!t.toString||t.toString().match(/^\[object/)?t:t.toString())}},loadState:function(){var t=this,n={};return n.photo=this.appContext.getModel("photo-models",this.photoId),n.privacy=this.appContext.getModel("photo-privacy-models",this.photoId),this.appContext.getViewer().signedIn&&(n.personPreferences=this.appContext.getModel("person-preferences-models",this.appContext.getViewer().nsid)),(new e.FlickrPromise(n)).then(function(e){t.set("photo",e.photo),t.set("privacy",e.privacy),e.personPreferences&&t.set("personPreferences",e.personPreferences)})},activate:function(){var t=this,n=this.get("photo"),r=this.get("privacy"),s=n.getValue("owner").getValue("isMe"),o=this.get("container");return r&&this.registerEventHandler(r.on("valuesChanged",function(n){var i=e.PrivacyHelper.mapPrivacy(r.toJSON()),s=o.one(".c-charm-item-privacy i");s.hasClass("ui-icon-tiny-privacy"+i.toLowerCase())||t.privacyDd.select(i)})),o.one(".flag-photo")&&this.registerEventHandler(o.one(".flag-photo").on("click",this.handleFlagPhotoClick,this)),this.safetyLevelDd=new e.Views.Dropdown({appContext:this.appContext,container:o.one(i.css.safetyLevel),selected:n.getValue("safetyLevel"),disabled:!s}),this.safetyLevelDd.on("open",function(n){t.fire("subviewViewEvent","make in view",t.safetyLevelDd.get("container")),e.rapidTracker.beacon(t.name,"safetySettingMenuClick")}),this.safetyLevelDd.on("close",function(e){t.fire("subviewViewEvent","close in view")}),this.safetyLevelDd.on("selected",function(e){t.setSafetyLevel(e.clicked.value)}),this.privacyDd=new e.Views.Dropdown({appContext:this.appContext,container:o.one(i.css.privacy),selected:e.PrivacyHelper.mapPrivacy(this.get("privacy").toJSON()),disabled:!s}),this.privacyDd.on("open",function(n){t.fire("subviewViewEvent","make in view",t.privacyDd.get("container")),e.rapidTracker.beacon(t.name,"privacySettingMenuClick")}),this.privacyDd.on("close",function(e){t.fire("subviewViewEvent","close in view")}),this.privacyDd.on("selected",function(e){t.setPrivacy(e.clicked.value)}),this.commentingPermissionDd=new e.Views.Dropdown({appContext:this.appContext,container:o.one(i.css.commentingPermission),selected:this.get("privacy").getValue("permComment"),disabled:!s}),this.commentingPermissionDd.on("open",function(n){t.fire("subviewViewEvent","make in view",t.commentingPermissionDd.get("container")),e.rapidTracker.beacon(t.name,"photoCommentPermissionConfirmationClick")}),this.commentingPermissionDd.on("close",function(e){t.fire("subviewViewEvent","close in view")}),this.commentingPermissionDd.on("selected",function(e){t.setCommentingPermission(e.clicked.value)}),this.addMetaPermissionDd=new e.Views.Dropdown({appContext:this.appContext,container:o.one(i.css.addMetaPermission),selected:this.get("privacy").getValue("permAddMeta"),disabled:!s}),this.addMetaPermissionDd.on("open",function(n){t.fire("subviewViewEvent","make in view",t.addMetaPermissionDd.get("container")),e.rapidTracker.beacon(t.name,"photoAddMetaPermissionMenuClick")}),this.addMetaPermissionDd.on("close",function(e){t.fire("subviewViewEvent","close in view")}),this.addMetaPermissionDd.on("selected",function(e){t.setAddMetaPermission(e.clicked.value)}),this.on("destroy",function(){try{t.safetyLevelDd.destroy(),t.privacyDd.destroy(),t.commentingPermissionDd.destroy(),t.addMetaPermissionDd.destroy()}catch(e){}}),this}})},"@VERSION@",{requires:["flickr-view","flickr-promise","dialog","dropdown","hermes-template-sub-photo-additional-info","sub-photo-additional-info-view-css","privacy-helper","hermes-template-flag-photo-dialog-content"],optional:[],langBundles:["common","photo-page-scrappy","settings"]});
YUI.add("sub-photo-right-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{initializer:function(e){return this.nsid=e.nsid,this.photoId=e.photoId,this.backToURL=e.backToURL,this.isOwner=e.isOwner,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},subviewConfig:{"photo-charm-exif-scrappy-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"sub-photo-right-stats-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"sub-photo-date-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"photo-license-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"sub-photo-tags-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"sub-photo-contexts-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"sub-photo-additional-info-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1}},loadState:function(){return e.Promise.resolve()},buildContainer:function(){return this.setContainerWithTemplate("sub-photo-right"),this},buildErrorContainer:function(){},activate:function(){return this}})},"@VERSION@",{requires:["flickr-view","hermes-template-sub-photo-right","sub-photo-right-css","photo-charm-exif-scrappy-view-css","url-helper"],optional:["photo-charm-exif-scrappy-view","sub-photo-right-stats-view","sub-photo-contexts-view","photo-license-view","sub-photo-date-view","sub-photo-additional-info-view"]});
YUI.add("hermes-template-sub-photo-keyboard-shortcuts",function(e,t){var n=e.Template.Handlebars.revive({1:function(e,t,n,r,i){var s,o=t!=null?t:{},u=n.helperMissing,a=e.escapeExpression;return'	<div class="sub-photo-keyboard-shortcuts">\n'+((s=n["if"].call(o,t!=null?t.signedIn:t,{name:"if",hash:{},fn:e.program(2,i,0),inverse:e.noop,data:i}))!=null?s:"")+'\n		<!--Search Shortcut -->\n		<div class="key-container">\n			<span class="search-key key">S</span>\n			<span class="search-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"common.SEARCH"},data:i}))+'</span>\n		</div>\n\n		<!--Photo Navigation Shortcut -->\n		<div class="key-container">\n			<span class="photo-navigation-key-left key"><i class="photo-navigation-key-icon-left"></i></span>\n			<span class="photo-navigation-key-right key"><i class="photo-navigation-key-icon-right"></i></span>\n			<span class="photo-navigation-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.PHOTO_NAVIGATION"},data:i}))+'</span>\n		</div>\n\n		<!--Thumbnail Navigation Shortcut -->\n		<div class="key-container">\n			<span class="thumbnail-navigation-key-left key"> &lt; </span>\n			<span class="thumbnail-navigation-key-right key"> &gt; </span>\n			<span class="thumbnail-navigation-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.THUMBNAIL_NAVIGATION"},data:i}))+"</span>\n		</div>\n\n		<!--Zoom Shortcut -->\n"+((s=n["if"].call(o,t!=null?t.enableZoom:t,{name:"if",hash:{},fn:e.program(5,i,0),inverse:e.program(7,i,0),data:i}))!=null?s:"")+'\n		<!--Back to Context Shortcut -->\n		<div class="key-container'+((s=n.unless.call(o,t!=null?t.canGoBackTo:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n			<span class="back-to-context-key key">B</span>\n			<span class="back-to-context-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.BACK_TO_CONTEXT"},data:i}))+"</span>\n		</div>\n\n"+((s=n["if"].call(o,t!=null?t.signedIn:t,{name:"if",hash:{},fn:e.program(9,i,0),inverse:e.noop,data:i}))!=null?s:"")+"	</div>\n"},2:function(e,t,n,r,i){var s,o=t!=null?t:{},u=n.helperMissing,a=e.escapeExpression;return'			<!--Favorite Shortcut -->\n			<div class="key-container'+((s=n["if"].call(o,t!=null?t.isOwner:t,{name:"if",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n				<span class="favorite-key key">F</span>\n				<span class="favorite-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"common.FAVORITE"},data:i}))+'</span>\n			</div>\n\n			<!--Comment Shortcut -->\n			<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddComment:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n				<span class="comment-key key">C</span>\n				<span class="comment-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.COMMENT"},data:i}))+"</span>\n			</div>\n"},3:function(e,t,n,r,i){return" disabled"},5:function(e,t,n,r,i){return'			<div class="key-container">\n				<span class="search-key key">Z</span>\n				<span class="search-key-label key-label">'+e.escapeExpression((n.intlMessage||t&&t.intlMessage||n.helperMissing).call(t!=null?t:{},{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ZOOM"},data:i}))+"</span>\n			</div>\n"},7:function(e,t,n,r,i){return'		<!--Lightbox Shortcut -->\n			<div class="key-container">\n				<span class="search-key key">L</span>\n				<span class="search-key-label key-label">'+e.escapeExpression((n.intlHTMLMessage||t&&t.intlHTMLMessage||n.helperMissing).call(t!=null?t:{},{name:"intlHTMLMessage",hash:{intlName:"photo-page-scrappy.VIEW_IN_LIGHTBOX"},data:i}))+"</span>\n			</div>\n"},9:function(e,t,n,r,i){var s,o=t!=null?t:{},u=n.helperMissing,a=e.escapeExpression;return"\n"+((s=n["if"].call(o,t!=null?t.isOwner:t,{name:"if",hash:{},fn:e.program(10,i,0),inverse:e.program(12,i,0),data:i}))!=null?s:"")+'\n			<!--Tagging Shortcuts -->\n			<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddMeta:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n				<span class="add-tag-key key">T</span>\n				<span class="add-tag-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TAG"},data:i}))+'</span>\n			</div>\n\n			<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddMeta:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n				<span class="add-person-key key">P</span>\n				<span class="add-person-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_PERSON"},data:i}))+"</span>\n			</div>\n"},10:function(e,t,n,r,i){var s,o=t!=null?t:{},u=n.helperMissing,a=e.escapeExpression;return'\n				<!--Add to Group Shortcut -->\n				<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddToGroup:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n					<span class="add-to-group-key key">G</span>\n					<span class="add-to-group-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TO_GROUP"},data:i}))+'</span>\n				</div>\n\n				<!--Add to album Shortcut -->\n				<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddToAlbum:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n					<span class="add-to-album-key key">A</span>\n					<span class="add-to-album-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TO_ALBUM"},data:i}))+"</span>\n				</div>\n\n"
},12:function(e,t,n,r,i){var s,o=t!=null?t:{},u=n.helperMissing,a=e.escapeExpression;return'\n				<!--Invite to group Shortcut -->\n				<div class="key-container'+((s=n.unless.call(o,t!=null?t.canInviteToGroup:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n					<span class="add-to-group-key key">G</span>\n					<span class="add-to-group-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.INVITE_TO_GROUP"},data:i}))+'</span>\n				</div>\n\n				<!--Add to gallery Shortcut -->\n				<div class="key-container'+((s=n.unless.call(o,t!=null?t.canAddToGallery:t,{name:"unless",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i}))!=null?s:"")+'">\n					<span class="add-to-album-key key">A</span>\n					<span class="add-to-album-key-label key-label">'+a((n.intlMessage||t&&t.intlMessage||u).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TO_GALLERY"},data:i}))+"</span>\n				</div>\n\n"},compiler:[7,">= 4.0.0"],main:function(e,t,n,r,i){var s;return(s=n["if"].call(t!=null?t:{},t!=null?t.keyboardShortcutsEnabled:t,{name:"if",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i}))!=null?s:""},useData:!0}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-keyboard-shortcuts",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("sub-photo-keyboard-shortcuts-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.nsid=e.nsid,this.photoId=e.photoId,this.backToURL=e.backToURL,this.hideBackToLink=e.hideBackToLink,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},loadState:function(){var t=this,n=[];return n.push(t.appContext.getModel("photo-models",t.photoId).then(function(e){t.set("photo",e)})),n.push(t.appContext.getModel("photo-privacy-models",t.photoId).then(function(e){t.set("photoPrivacyModel",e)})),t.appContext.getViewer().signedIn&&n.push(t.appContext.getModel("person-groups-models",t.appContext.getViewer().nsid).then(function(e){t.set("personGroupsModel",e)})),e.Promise.all(n)},buildContainer:function(){return this.setContainerWithTemplate("sub-photo-keyboard-shortcuts",{signedIn:this.appContext.getViewer().signedIn,isOwner:this.get("photo").getValue("owner").getValue("isMe"),enableZoom:this.appContext.flipper.isFlipped("enable-scrappy-zoom"),canAddToAlbum:this.canAddToAlbum(),canAddToGallery:this.canAddToGallery(),canAddToGroup:this.canAddToGroup(),canInviteToGroup:this.canInviteToGroup(),canAddMeta:this.canAddMeta(),canAddComment:this.get("photo").getValue("canComment"),canGoBackTo:!this.hideBackToLink,keyboardShortcutsEnabled:this.appContext.getViewer().prefs.keyboardShortcutsEnabled}),this},canAddToGallery:function(){var e=this.get("photo").getValue("safetyLevel")===0,t=this.get("photoPrivacyModel").getValue("isPublic");return e&&t&&this.appContext.getViewer().nsid!==this._params.nsid&&this.appContext.getViewer().signedIn},canAddToAlbum:function(){return this.appContext.getViewer().nsid===this._params.nsid},canAddToGroup:function(){var e=this.appContext.getViewer().nsid,t=this.get("photo").getValue("owner").getValue("id"),n=this.get("personGroupsModel");return t===e&&n&&(this.get("personGroupsModel").getValue("memberCount")>0||this.get("personGroupsModel").getValue("adminCount")>0||this.get("personGroupsModel").getValue("moderatorCount")>0)},canInviteToGroup:function(){var e=this.appContext.getViewer().nsid,t=this.get("photo").getValue("owner").getValue("id"),n=this.get("personGroupsModel");return t!==e&&n&&n.getValue("adminCount")>0},canAddMeta:function(){var e=this.get("photo");return e.getValue("owner")||e.getValue("canAddMeta")},buildErrorContainer:function(){},activate:function(){return this}})},"@VERSION@",{requires:["flickr-view","hermes-template-sub-photo-keyboard-shortcuts","url-helper","sub-photo-keyboard-shortcuts-css"],optional:[],langBundles:["common","photo-page-scrappy"]});
YUI.add("sub-photo-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{initializer:function(e){return this.nsid=e.nsid,this.photoId=e.photoId,this.backToURL=e.backToURL,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},subviewConfig:{"sub-photo-left-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"sub-photo-right-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"sub-photo-keyboard-shortcuts-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1}},loadState:function(){return e.Promise.resolve()},buildContainer:function(){return this.setContainerWithTemplate("sub-photo"),this},buildErrorContainer:function(){},activate:function(){return this}})},"@VERSION@",{requires:["flickr-view","hermes-template-sub-photo","sub-photo-css","url-helper"],optional:["sub-photo-left-view","sub-photo-right-view","sub-photo-keyboard-shortcuts-view"]});
YUI.add("photo-page-scrappy-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){var n=this;this.backToURL=t.backToURL,this.hideBackToLink=t.hideBackToLink||!1,this.entryTypeIntlKey=t.entryTypeIntlKey,this.photoId=t.photoId,this.isOwner=t.isOwner,this.context=e.clone(t.context,!0),this.nsid=t.nsid,t.isOwner=this.isOwner,t.fullscreen?this.appContext.experiments.fullscreen.enableFullscreen():this.appContext.experiments.fullscreen.disableFullscreen(),this.appContext.getViewer().signedIn&&(t.signinPendingQueue=e.SigninHelper.checkPendingQueue(this.appContext));if(this.context&&this.context.params&&this.context.params.isSharedEntity){var r=this.context.params;this.appContext.setGPCredentials({gp_code:r.gpCode,gp_owner:r.gpOwner,share_code:r.gpCode})}else this.appContext.setGPCredentials(null);return this.appContext.getModel("photo-models",this.photoId).then(function(t){t.on("valuesChanged",function(t){t.title&&e.one&&e.one("head title").set("text",n.intlMessage({intlName:"photo-page-scrappy.PAGE_TITLE",title:t.title.newVal}))})}),YUI.Env.isServer&&this.appContext&&this.appContext.flipper.isFlipped("enable-better-photo-page-seo")&&(this.appContext.forceServerRender=this.appContext._doForcedServerRender()),t.logViewTimings=!0,this},subviewConfig:{"photo-well-scrappy-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0,dealbreaker:!0},"photo-head-meta-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"global-nav-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"sub-photo-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"signup-footer-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,disabled:function(e){return e.isMobile||!this.appContext.flipper.isFlipped("enable-mini-sign-up-footer")||this.appContext.getViewer().signedIn||this.appContext.lang!=="en-US"}},"footer-full-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0}},additionalViewClasses:function(){var e=[];return!this.appContext.getViewer().signedIn&&this.appContext.flipper.isFlipped("global-nav-enabled")&&e.push("has-global-nav"),e},loadState:function(){var e=this;return this.appContext.getModel("photo-models",e.photoId).then(function(t){e.set("photo",t)})},buildContainer:function(){var t,n=!1;return n?t="":t=this.subviews["global-nav-view"].get("container"),this.setContainerWithTemplate("photo-page-scrappy",{"global-nav-view":t,"photo-well-view":this.subviews["photo-well-scrappy-view"]?this.subviews["photo-well-scrappy-view"].get("container"):""}),e.fletrics.increment("test.photo.page.requests"),this},activate:function(){var t=this,n;return this.appContext.adManager.isEnabled()&&(this.appContext.adManager.updatePhotoAdsCounter(),this.appContext.adManager.fetchAdIfRequired({spaceid:this.get("spaceid")})),this.appContext.flipper.isFlipped("enable-curator-tools")&&this.appContext.getViewer().isInsecureGod&&(n=new e.Views["curator-photo-tools-view"]({nsid:t.nsid,photoId:t.photoId}),n.appContext=this.appContext,n.loadState().then(function(){n.buildContainer(),n.activate(),this.curatorPhotoToolsView=n}),this.curatorPhotoToolsView=n),this},closeDialog:function(t){e.config.win.location.href=this.backToURL},onSubviewEvent:function(e,t){var n;if(t&&t.length>0&&!(t[0]==="make in view"&&t.length>1)&&t[0]!=="close in view")if(t[0]==="getDialogOffset")t[1]&&typeof t[1]=="function"&&(n=this.subviews["photo-well-scrappy-view"].get("container"),n&&t[1](parseInt(n.getStyle("right").replace("px",""),10)/2));else if(t[0]==="setRedirect")this.get("container").all("input[name=redirect_url]").setAttribute("value",window.location.pathname),typeof t[1]=="function"&&t[1]();else{if(t[0]==="rightClickPhoto")return!1;t[0]==="photo:reload"?this.reload(["photo-models","photostream-models","photo-exif-models"],this.photoId):(t[0]==="disable-sharing"||t[0]==="enable-sharing")&&this.fire("parentViewEvent",t[0])}},getTrackingSegments:function(){return{context:this.context.modelName.replace("-models",""),vwrOwner:this.isOwner?1:0,licnsbl:this.get("photo").getValue("isMarketplaceLicensable")}},destructor:function(){clearTimeout(this.scrollTimeout),this.curatorPhotoToolsView&&this.curatorPhotoToolsView.destroy()},buildErrorContainer:function(){this.error&&this.error.is404&&this.appContext.flapp.navigate("/error/notfound")}},{ATTRS:{spaceid:{value:792600543}}}),e.Base.plug(e.Views[this.name],e.Plugin.FlickrView.TTFPRecorderPlugin,{selector:".main-photo"})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-page-scrappy","photo-css","util-css","fletrics","ttfp-recorder-plugin","signin-helper","dialog","overflow-helper","url","fluid-css","curator-photo-tools-view"],optional:["photo-well-scrappy-view","photo-head-meta-view","global-nav-view","sub-photo-view","signup-footer-view"],langBundles:["common","photo-page-scrappy"]});
YUI.add("photo-route",function(e,t){function s(e){s.superclass.constructor.call(this,e)}var n=require("lib/helpers/type-validator"),r=require("lib/flog")(t),i={activity_feed:{backToIntlKey:"BACK_TO_ACTIVITY_FEED",usesWith:!1},album:{backToIntlKey:"BACK_TO_ALBUM",usesWith:!0},commons:{backToIntlKey:"BACK_TO_COMMONS",usesWith:!1},contacts_list:{backToIntlKey:"BACK_TO_CONTACTS_LIST",usesWith:!1},explore:{backToIntlKey:"BACK_TO_EXPLORE",usesWith:!0},favorites:{backToIntlKey:"BACK_TO_FAVORITES",usesWith:!0},gallery:{backToIntlKey:"BACK_TO_GALLERY",usesWith:!0},groups:{backToIntlKey:"BACK_TO_GROUPS"},group:{backToIntlKey:"BACK_TO_GROUP",usesWith:!0,withParamName:"pool/with"},map:{backToIntlKey:"BACK_TO_MAP",usesWith:!1},photostream:{backToIntlKey:"BACK_TO_PHOTOSTREAM",usesWith:!0},profile:{backToIntlKey:"BACK_TO_PROFILE",usesWith:!1},search:{backToIntlKey:"BACK_TO_SEARCH",usesWith:!1},shares:{backToIntlKey:"BACK_TO_SHARED_PHOTOS",usesWith:!1},tags:{backToIntlKey:"BACK_TO_TAG",usesWith:!1},tag:{backToIntlKey:"BACK_TO_TAG",usesWith:!1}};e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t,i){var s=this,o=t.params.nsid_or_path_alias,u=t.params.photo_id,a=t.params.context,f=t.params.lightbox==="lightbox",l=t.params.vr==="vr",c=t.params.comment_id,h={id:u},p=t.query||{},d=!1,v;return c&&i.redirect(t.url.replace("/"+c,"")+"#"+c),n.nsid(o)?h.userId=o:h.pathAlias=o,v=s.parseContext(a,o,t),v&&v.params&&v.params.isSharedEntity?this.appContext.setGPCredentials({gp_code:v.params.gpCode,gp_owner:v.params.gpOwner,share_code:v.params.gpCode}):this.appContext.setGPCredentials(null),p&&p.cr!==undefined&&(d=!0),this.appContext.flipper.isFlipped("get-context-photos-in-photo-page-route")&&(v&&v.params&&v.modelName&&v.modelName!=="photostream-models"?h.context=a:h.context="photostream"),this.appContext.getModel("photo-models",h).then(function(n){var u,c,h,p,m,g,y,b,w,E,S;g=f?"photo-page-lightbox-scrappy-view":"photo-page-scrappy-view",y="scrolling",b="photo-page-ad-scrappy-view",w="scrolling",u=s.verifyPhotoIsViewable(n),m=s.detectRouteErrors(u);if(m.length)return s.displayRouteErrors(t,m);c=s.verifyPhotoIsOwnedByPerson(n,o),S=c,m=s.detectRouteErrors(c);if(m.length)return s.displayRouteErrors(t,m);var x=6,T=12;s.appContext.forceServerRender&&(x=2,T=0),s.detectBackToDestination(t,{person:o,photoId:u,context:a}),E=s.getBackToData();if(m.length)return s.displayRouteErrors(t,m);v.modelName==="photostream-models"&&(v.params.id=e.Models[v.modelName].buildCompoundId(c,v.params.orderBy,v.params.viewAs),S=v.params.id,delete v.params.pathAlias);if(s.appContext.adManager.isEnabled()&&s.appContext.adManager.adNext()&&!f&&!t.UA.isMobileBrowser){p=s.appContext.adManager.getAdJSON();if(p&&e.Lang.isObject(p))return h=p.brand||"",{view:b,params:{ad:!0,photoId:u,nsid:c,photostreamId:S,context:v,backToURL:E.path,hideBackToLink:d,entryTypeIntlKey:E.backToIntlKey,numberOfPositionsToPreFetch:x,numberOfPositionsToRefetchAt:T},title:h,layout:w,fluid:!0};r.error("Could not extract brand name from brand payload",{ad:p})}var N=!0,C=!1;return s.appContext.flipper.isFlipped("enable-new-mobile-photo-page")&&s.isProcessedAsMobileRequest(t,i)&&(g="mobile-photo-page-view",N=!1,C=!0),t.UA.isFacebook&&(g="photo-page-meta-tags-only",y="opengraph",N=!1),{view:g,params:{photoId:u,nsid:c,photostreamId:S,context:v,backToURL:E.path,hideBackToLink:d,entryTypeIntlKey:E.backToIntlKey,fullscreen:f,numberOfPositionsToPreFetch:x,numberOfPositionsToRefetchAt:T,isVR:l},title:n.getValue("title")||"Untitled",layout:y,fluid:!0,darkLoader:N,isMobile:C}},function(n){var r="Couldn't load photo page";t.UA.isMobileBrowser&&s.appContext.flipper.isFlipped("enable-new-mobile-photo-page")&&(r="Couldn't load mobile photo page"),n.message&&(r+=": "+n.message);if(n.code===1)return e.fletrics.increment("route.photo.route.404"),s.displayRouteErrors(t,new e.RouteError(404,r));if(n.code===2){if(!s.appContext.getViewer().signedIn)return e.Promise.resolve({redirect:"/signin/?redir="+t.url})}else if(!t.UA.isMobileBrowser)return{view:"empty-photo-page-view",params:{},title:s.intlMessage({intlName:"common.OOPS"}),layout:"scrolling",fluid:!0,darkLoader:!0,isMobile:!1};if(n.fatal)throw e.fletrics.increment("route.photo.route.500"),n;return e.fletrics.increment("route.photo.route.404"),s.displayRouteErrors(t,new e.RouteError(404,r))})},verifyPhotoIsViewable:function(t){var r=t.getValue("id");return n.photoId(r)?r:new e.RouteError(404,this.intlMessage({intlName:"photo-page-scrappy.NO_PHOTO_WITH_THAT_ID",photoId:r}))},verifyPhotoIsOwnedByPerson:function(t,r){var i=t.getValue("id"),s=n.nsid(r);return r===t.getValue("owner").getValue(s?"id":"pathAlias")?t.getValue("owner").getValue("id"):new e.RouteError(404,"Photo "+i+" is not owned by "+r)},parseContext:function(t,n,r){return t=t||"photostream",e.URLHelper.parseContextURL(t,n,this.appContext)},detectBackToDestination:function(t,n){var r,i,s,o,u;if(e.config.flickr.homerun&&(e.config.flickr.ycParam||t.query&&t.query.yc)){u=e.config.flickr.ycParam?e.config.flickr.ycParam:t.query.yc;if(e.config.flickr.homerun.yc.indexOf(u.replace(/https?\:\/\//,""))!==-1)return this.setBackToData({name:"Yahoo"},u.match(/https?:/)?u:"https://"+u,n)}if(YUI.Env.isServer){r=t.headers.referrer||t.headers.referer;if(/^https?:\/\/[^\/]*(?:flickr\.com|flic\.kr)(?:$|\/)/.test(r)){if(n.context)return i=e.URLHelper.getContextEntity(n.context,n.person),this.setBackToData(e.URLHelper.getSiteSectionByName(i.type),i.url,n);r="/"+r.split("/").slice(3).join("/"),o=e.URLHelper.getSiteSectionByURL(r);if(o)return this.setBackToData(o,o.match,n)}else if(n.context)return i=e.URLHelper.getContextEntity(n.context,n.person),this.setBackToData(e.URLHelper.getSiteSectionByName(i.type),i.url,n)}else{r=this.appContext.getPreviousURL(),s=this.appContext.flapp.get("activeView");if(["photo-page-scrappy-view","photo-page-lightbox-scrappy-view","minimal-photo-page-view","photo-page-ad-scrappy-view"].indexOf(s.name)>-1){if(s.backToURL){o=e.URLHelper.
getSiteSectionByURL(s.backToURL);if(o)return this.setBackToData(o,s.backToURL,n)}}else if(r!==e.config.win.location.pathname){o=e.URLHelper.getSiteSectionByURL(r);if(o)return this.setBackToData(o,o.match,n)}}return this.setBackToData(null,null,n)},setBackToData:function(t,n,r){var o=YUI.Env.isServer?this:s,u,a,f;u=t?i[t.name]:null,u||(t=e.URLHelper.getSiteSectionByName("photostream"),n="/photos/"+r.person,u=i.photostream),a=e.merge(u,t),f=a.withParamName||"with",n=this.stripPathSuffixes(n),a.usesWith&&(n=n.replace(/([^\/])$/,"$1/"),n+=f+"/"+r.photoId),n[n.length-1]!=="/"&&n.indexOf("?")===-1&&(n+="/"),o._entryType=a.name,o._entryPath=n,o._backToIntlKey=a.backToIntlKey},getBackToData:function(){var e=YUI.Env.isServer?this:s;return{type:e._entryType,path:e._entryPath,backToIntlKey:e._backToIntlKey}},stripPathSuffixes:function(e){return e=e.replace(/\/+/g,"/"),e=e.replace(/\/with\/\d+\/?$/,"/"),e=e.replace(/\/in\/[^\/]+\/?$/,"/"),e=this.filterURL(e,function(e){var t;if(e.length>=3)for(t=2;t<e.length;t++)e[t].match(/page\d+/)&&(e.splice(t,1),t--);return e}),e=this.filterURL(e,function(e){var t;if(e[0]==="groups"&&e.length>=3)for(t=2;t<e.length;t++)e[t]==="pool"&&(e.splice(t,1),t--);return e}),e},filterURL:function(e,t){var n,r;return r=e.split("/").filter(function(e){return!!e}),n="/"+t(r).join("/"),n[n.length-1]!=="/"&&e.indexOf("?")===-1&&(n+="/"),n}}),e.mix(s.prototype,e.Localizable),e.mix(s.prototype,e.Seo)},"@VERSION@",{requires:["flickr-route","url-helper","fletrics","localizable","seo"],optional:["photo-models","photostream-models","photo-page-scrappy-view","empty-photo-page-view","photo-page-lightbox-scrappy-view","mobile-photo-page-view"],langBundles:["photo-page-scrappy","common","attribution"]});
YUI.add("photo-well-view",function(e,t){var n=require("lib/flog")(t),r=1,i=5;e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.contextData=e.clone(t.context,!0),this.isAd=!!t.ad,this.firstLoad=!!t.firstLoad,this.publisherUrl=t.publisherUrl,t.isFluid=!0,t.isOnDark=!0,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},subviewConfig:{"photo-well-media-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"photo-sidebar-toggle-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1},"attribution-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:["is-real-fullscreen","photo-attribution"]},"photo-sidebar-actions-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:["is-real-fullscreen"],disabled:function(){return this.appContext.experiments.fullscreen.disableRealFullscreenButtons()}},"people-notes-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,disabled:!0}},buildContainer:function(){var e=this,t="",n,r=0,i,s,o=".navigate-prev",u=".navigate-next",a,f,l,c;return this.firstLoad||(this.subviews["photo-sidebar-actions-view"]&&this.subviews["photo-sidebar-actions-view"].get("container").addClass("is-hidden"),this.subviews["photo-sidebar-toggle-view"]&&this.subviews["photo-sidebar-toggle-view"].get("container").addClass("is-hidden")),this.appContext.experiments.fullscreen.getMode()?this.subviews["attribution-view"]&&(YUI.Env.isServer||this.subviews["attribution-view"].get("container").removeClass("is-always-hidden"),!this.firstLoad&&this.contextData.modelName!=="photoList-models"&&this.contextData.modelName!=="explore-models"&&this.subviews["attribution-view"].get("container").addClass("is-hidden"),t=this.subviews["attribution-view"].get("container")):this.subviews["attribution-view"]&&(this.subviews["attribution-view"].get("container").addClass("is-always-hidden"),t=this.subviews["attribution-view"].get("container")),this.get("contextModel")&&(n=this.get("contextModel").getValue("photoContextList").getList(),n.length>2&&n.some(function(t){return r++,t.getValue("id")===e.photoId})&&(i=n.slice(r-2,r-1),s=n.slice(r,r+1),i&&i.length>0&&(a=e.setupNavLink(i[0],o,"previous"),i[0].getValue("owner")&&(i[0].getValue("title").trim()===""?l=e.intlMessage({intlName:"common.UNTITLED"}):l=i[0].getValue("title"),l+=" | "+e.intlMessage({intlName:"common.BY_USER",user:i[0].getValue("owner").getValue("username")}))),s&&s.length>0&&(f=e.setupNavLink(s[0],u,"next"),s[0].getValue("title").trim()===""?c=e.intlMessage({intlName:"common.UNTITLED"}):c=s[0].getValue("title"),c+=" | "+e.intlMessage({intlName:"common.BY_USER",user:s[0].getValue("owner").getValue("username")})))),this.setContainerWithTemplate("photo-well",{"is-video":this.get("photo").getValue("isVideo"),"is-hidden":(YUI.Env.isServer||!this.firstLoad)&&!a&&!f,"prev-is-not-clickable":!a,"next-is-not-clickable":!f,"prev-url":a,"next-url":f,"prev-title":l,"next-title":c,"is-ad":this.isAd,"opt-out-enabled":this.appContext.experiments.optOut.enabled(),"attribution-view":t,enableZoom:this.appContext.flipper.isFlipped("enable-scrappy-zoom")}),YUI.Env.isServer&&(this.serverWidth=this.subviews["photo-well-media-view"].serverWidth,this.serverHeight=this.subviews["photo-well-media-view"].serverHeight),this},loadState:function(){var t=this,n=[];return n.push(this.appContext.getModel("photo-models",this.photoId).then(function(e){if(!e)throw new Error("[photo-well-view] Invalid photoModel returned from getModel");t.set("photo",e)})),this.contextData&&this.contextData.modelName&&this.contextData.params&&n.push(this.appContext.getModelRegistry(this.contextData.modelName).then(function(e){var n;if(e){n=e.attributeSearch(t.contextData.params);if(n&&n.length&&e.exists(n[0]))return t.appContext.getModel(t.contextData.modelName,n[0]).then(function(e){e&&t.set("contextModel",e)})}}).then(null,function(){return"whatever"})),e.Promise.all(n)},setLinkAsAdFriendly:function(e){var t=e.currentTarget;t.hasClass("navigate-next")?this.appContext.adManager.setAdCouldBeShown(!0,"next",t.getAttribute("href")):this.appContext.adManager.setAdCouldBeShown(!0,"previous",t.getAttribute("href"))},animateNavigation:function(){var t=e.all(".navigate-target"),n=this.get("container"),r=n.one(".photo-sidebar-toggle-view"),i=n.one(".attribution-view"),s=1500,o=250,u=!1,a=!1,f,l=!0,c=this;s=(s-500)/2,u=!0,a=this.appContext.experiments.fullscreen.getMode(),this.registerEventHandler(this.get("container").on("mousemove",e.betterThrottle(function(e){f=n.one(".photo-sidebar-actions-view"),t&&l&&t.removeClass("is-hidden"),u&&l&&(f&&f.removeClass("is-hidden"),r&&r.removeClass("is-hidden"),i&&i.removeClass("is-hidden")),clearTimeout(c.movingTimeout),clearTimeout(c.initialTimeout),l=!0,c.followViewOpen||(c.movingTimeout=setTimeout(c.hideUI.bind(c),s*2))},o))),!this.firstLoad&&this.contextData.modelName!=="photoList-models"&&this.contextData.modelName!=="explore-models"&&(l=!1),c.initialTimeout=setTimeout(function(){l=!0,f=n.one(".photo-sidebar-actions-view"),t&&c.firstLoad&&t.addClass("is-hidden"),u&&l&&(f&&f.addClass("is-hidden"),r&&r.addClass("is-hidden"),i&&i.addClass("is-hidden"))},s*2)},hideUI:function(){var e=this.get("container"),t=e.one(".photo-sidebar-actions-view"),n=e.one(".photo-sidebar-toggle-view"),r=e.one(".attribution-view");t&&t.addClass("is-hidden"),n&&n.addClass("is-hidden"),r&&r.addClass("is-hidden")},onSubviewEvent:function(e,t){var n=1500;n=(n-500)/2,e==="attribution-view"&&t[0]==="isOpen"?(this.followViewOpen=!0,clearTimeout(this.movingTimeout),clearTimeout(this.initialTimeout)):e==="attribution-view"&&t[0]==="isClosed"&&(this.followViewOpen=!1,this.movingTimeout=setTimeout(this.hideUI.bind(this),n*2))},activate:function(){var t=this,s=this.contextData,o=this.get("container"),u=0,a,f,l,c,h=".navigate-prev",p=".navigate-next";return YUI.Env.isServer||(f=e.getLocation(),l=f.protocol,c=f.hostname,t.appContext
.getModel(s.modelName,s.params).then(function(e){t.set("contextModel",e)},function(n){if(!n.getModelFailure&&n.code!==1||s.modelName==="photostream-models")throw e.all(h).hide(),e.all(p).hide(),n;return t.contextData.modelName="photostream-models",t.contextData.params.id=t.get("photo").getValue("owner").getValue("nsid"),t.appContext.getModel("photostream-models",t.contextData.params).then(function(e){t.set("contextModel",e)})}).then(function(){var n=t.get("contextModel").getValue("photoContextList"),r=n.getList(),i,o,a,f,d;return r.length>2&&r.some(function(e){return u++,e.getValue("id")===t.photoId})&&(o=r.slice(u-2,u-1),a=r.slice(u,u+1),o&&o.length>0&&(f=t.setupNavLink(o[0],h,"previous"),f&&(t.updateNavLinks(h,l,c,f),t.get("container").all(h).removeClass("no-click"))),a&&a.length>0&&(d=t.setupNavLink(a[0],p,"next"),d&&(t.updateNavLinks(p,l,c,d),t.get("container").all(p).removeClass("no-click")))),i=e.merge(s.params,{photoId:t.photoId,numNext:10,numPrev:10}),n.getContext(i)}).then(function(n){function s(s,o){var u=t.get("container").all(s),a,f,h,p,d,v,m=n&&n[o]&&n[o].length;if(!u.size())return;if(!m){u.remove();return}u.removeClass("no-click"),a=t.setupNavLink(n[o][0],s,o);if(t.isAd)h=t.appContext.adManager.origin,o===h.arrow?(u.setAttribute("href",h.url),u.removeClass("is-hidden")):(u.setAttribute("href",a),u.removeClass("is-hidden"));else{t.updateNavLinks(s,l,c,a),f=t.subviews["photo-well-media-view"].getCanvasSize();for(v=0;v<i;v++){if(!n[o][v])break;p=n[o][v].getSizeToFit(f,{includeSizes:["sq","q","t","s","n"]}),p&&p.url&&(d=new Image,d.src=p.url)}for(v=0;v<r;v++){if(!n[o][v])break;p=n[o][v].getSizeToFit(f),p&&p.url&&(d=new Image,e.LH.mark("mark_time_to_load_photo_only_start"),d.onload=function(){e.LH.mark("mark_time_to_load_photo_only");var t=e.LH.measure("time_to_load_photo_only",{startMark:"mark_time_to_load_photo_only_start",endMark:"mark_time_to_load_photo_only"});window.beaconError&&window.beaconError("time_to_load_photo_only",window.location.href,{duration:t.duration})},d.src=p.url)}}}t.appContext.adManager.updateContext({prev:n.previous[0],current:t.get("photo"),next:n.next[0],type:t.contextData.modelName}),s(p,"next"),s(h,"previous"),t.animateNavigation(),t.isAd&&t.appContext.adManager.markAdAsSeen()},function(e){if(e.notInContext||e.code===99)return t.get("contextModel").setValue("photoContextList",[]),t.contextData.modelName="photostream-models",t.contextData.params.id=t.get("photo").getValue("owner").getValue("nsid"),t.activate();throw e}).then(null,function(e){n.warn("There was a problem initializing the next/previous controls.",{err:e})}),this.attachKeyEvent("down:37,75,39,74",t.handlePrevNextKeys.bind(t)),this.get("photo").getValue("isOwner")||this.appContext.getViewCounter().queue(this.get("photo").getValue("id"),this.publisherUrl||this.appContext.getReferrer())),o&&o.one(".feedback-widget button")&&(this.registerEventHandler(o.one(".feedback-widget button").on("mousedown",t.handleFeedbackClick,t)),this.setupFeedbackDropdown(),e.Env.isServer||o.all("input[name=redirect_url]").setAttribute("value",e.config.win.location.pathname)),a={":ad":t.setLinkAsAdFriendly},t.attachEvents(a),this},setupNavLink:function(t,r,i){var s=this.get("container").all(r),o,u;if(!t&&s.size()){s.remove();return}o=t,u=e.URLHelper.getPhotoPage({photoId:o.getValue("id"),pathAlias:o.getValue("owner").getValue("pathAlias"),contextSuffix:this.get("contextModel").getValue("urlSuffix"),lightbox:this.appContext.experiments.fullscreen.getMode()});if(!u||u==="#"){n.warn("Invalid next/prev URL",{url:u}),s.remove();return}return u},updateNavLinks:function(e,t,n,r){var i=this.get("container").all(e);i.setAttribute("href",t+"//"+n+r),this.firstLoad&&i.removeClass("is-hidden")},destructor:function(){clearTimeout(this.movingTimeout),clearTimeout(this.initialTimeout),this.movingTimeout=null,this.initialTimeout=null},setupFeedbackDropdown:function(){var t=this.get("container"),n,r,i;if(this.appContext.flipper.isFlipped("buckets"))switch(this.appContext.buckets.photo_page){case"bucket1":i="https://yahoo.uservoice.com/forums/230780-flickr-photo-page-beta/";break;case"bucket2":i="https://yahoo.uservoice.com/forums/230781-flickr-photo-page-beta-2/";break;case"bucket3":i="https://yahoo.uservoice.com/forums/230782-flickr-photo-page-beta-3/";break;case"bucket4":i="https://yahoo.uservoice.com/forums/230783-flickr-photo-page-beta-4/";break;case"bucket5":i="https://yahoo.uservoice.com/forums/230785-flickr-photo-page-beta-5";break;case"bucket6":i="https://yahoo.uservoice.com/forums/230786-flickr-photo-page-beta-6";break;case"bucket7":i="https://yahoo.uservoice.com/forums/230787-flickr-photo-page-beta-7/";break;case"bucket8":i="https://yahoo.uservoice.com/forums/230788-flickr-photo-page-beta-8/";break;default:i="https://yahoo.uservoice.com/forums/224533-flickr-photo-page-beta"}else i="https://yahoo.uservoice.com/forums/224533-flickr-photo-page-beta";r=[{buttonMarkup:new e.Handlebars.SafeString('<a href="'+i+'" data-track="helpFeedbackUserVoiceClick" class="ui-button" target="_blank"><span>Feedback</span></a>')},{buttonMarkup:new e.Handlebars.SafeString('<a href="//'+e.config.flickr.url.host+'/help/photos/#167391143" data-track="helpFeedbackFAQClick" class="ui-button" target="_blank"><span>FAQs</span></a>')}],n=this.templates("reboot-welcome-dialog-content")({"opt-out-enabled":this.appContext.experiments.optOut.enabled()}),this.appContext.experiments.optOut.enabled()&&r.push({buttonMarkup:new e.Handlebars.SafeString(this.templates("photo-opt-out")({"redirect-url":e.config.win.location.pathname}))}),this.feedbackDialog=e.Views.dialog.getNewInstance("dialog-cta",{attrs:{title:"Welcome to the beta of the new photo page!",hideConfirmButton:!0,verticalButtonList:!0,additionalButtons:r},content:n,parent:this,rootEl:t.ancestor()}),this.feedbackDialog.get("container").addClass("welcome-dialog")},handleFeedbackClick:function(t){if(t.target.ancestor(".ui-dialog",!0))return;t.halt(),this.feedbackDialog.toggle(),e.rapidTracker.beacon(this
.name,"helpFeedbackMenuClick")},handlePrevNextKeys:function(t){var r=this,i,s,o,u=50;if(t.button===37||t.button===75)s=".navigate-prev",o="previous",e.rapidTracker.beacon(this.name,"prevPhotoKeyPress");else if(t.button===39||t.button===74)s=".navigate-next",o="next",e.rapidTracker.beacon(this.name,"nextPhotoKeyPress");s&&r.get("container").one(s)&&(t.preventDefault(),i=r.get("container").one(s).getAttribute("href"),i&&i!=="#"&&(r.keyboardNavigation&&r.keyboardNavigation.url&&i===r.keyboardNavigation.url&&(new Date).getTime()-r.keyboardNavigation.time<u?n.log("Ignoring duplicate keyboard navigation",{url:i}):(r.keyboardNavigation={url:i,time:(new Date).getTime()},this.appContext.adManager.setAdCouldBeShown(!0,o,i),r.appContext.flapp.navigate(i))))},handleContextMenu:function(e){e.preventDefault(),this.fire("subviewViewEvent","rightClickPhoto")}})},"@VERSION@",{requires:["yui-throttle","flickr-view","hermes-template-photo-well","photo-well-css","url-helper","better-throttle","hermes-template-reboot-welcome-dialog-content","hermes-template-photo-opt-out"],optional:["photo-well-media-view","photo-models","photo-route"],langBundles:["common"]});
